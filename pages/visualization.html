<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>数据可视化</title>
  <link rel="stylesheet" href="../styles/style.css">
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
</head>
<body class="iframe-page">
  <div class="page-content">
    <h1>数据可视化</h1>
    <p class="page-description">基于CSV数据的多维度可视化分析</p>
    <!-- 图表控制面板 -->
    <div class="chart-controls">
      <button id="loadSampleData" class="control-btn">加载示例数据</button>
      <input type="file" id="csvFileInput" accept=".csv" style="display: none;">
      <button id="uploadCsv" class="control-btn">上传CSV文件</button>
      <div class="chart-tabs">
        <button class="tab-btn active" data-chart="line">折线图</button>
        <button class="tab-btn" data-chart="pie">饼图</button>
        <button class="tab-btn" data-chart="scatter3d">3D散点图</button>
      </div>
    </div>
    
    <!-- 图表容器 -->
    <div class="chart-container">
      <div id="lineChart" class="chart-panel active">
        <h3>Score1随ID变化趋势</h3>
        <div id="lineChartDiv" style="width:100%;height:400px;"></div>
      </div>
      
      <div id="pieChart" class="chart-panel">
        <h3>兴趣领域分布</h3>
        <div id="pieChartDiv" style="width:100%;height:400px;"></div>
      </div>
      
      <div id="scatter3dChart" class="chart-panel">
        <h3>三维能力坐标分布</h3>
        <div id="scatter3dChartDiv" style="width:100%;height:500px;"></div>
      </div>
    </div>
    
    <!-- 数据统计卡片 -->
    <div class="stats">
      <div class="stat-card">
        <h3>总记录数</h3>
        <p id="totalRecords">0</p>
      </div>
      <div class="stat-card">
        <h3>平均年龄</h3>
        <p id="avgAge">0</p>
      </div>
      <div class="stat-card">
        <h3>最高分数</h3>
        <p id="maxScore">0</p>
      </div>
    </div>
  </div>
  
  <script>
    let csvData = [];
    
    // 加载示例数据
     async function loadSampleData() {
        try {
          // 修正相对路径，从iframe页面访问上级目录的data文件夹
          const response = await fetch('../data/sample.csv');
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const csvText = await response.text();
          csvData = parseCSV(csvText);
          updateCharts();
          updateStats();
          console.log('成功加载CSV数据:', csvData.length, '条记录');
        } catch (error) {
          console.error('加载示例数据失败:', error);
          alert('无法加载CSV文件，请确保服务器正在运行并且文件路径正确');
        }
      }
    
    // 解析CSV数据
    function parseCSV(csvText) {
      const lines = csvText.trim().split('\n');
      const headers = lines[0].split(',');
      const data = [];
      
      for (let i = 1; i < lines.length; i++) {
        const values = lines[i].split(',');
        const row = {};
        headers.forEach((header, index) => {
          const value = values[index];
          if (header === 'id' || header === 'age' || header.includes('score')) {
            row[header] = parseInt(value) || 0;
          } else {
            row[header] = value;
          }
        });
        data.push(row);
      }
      return data;
    }
    
    // 更新所有图表
    function updateCharts() {
      if (csvData.length === 0) return;
      
      // 折线图：score1随id变化
      const lineTrace = {
        x: csvData.map(d => d.id),
        y: csvData.map(d => d.score1),
        type: 'scatter',
        mode: 'lines+markers',
        name: 'Score1',
        line: { color: '#3498db', width: 3 },
        marker: { size: 8, color: '#e74c3c' }
      };
      
      const lineLayout = {
        title: 'Score1随ID变化趋势',
        xaxis: { title: 'ID' },
        yaxis: { title: 'Score1' },
        margin: { t: 50, r: 50, b: 50, l: 50 }
      };
      
      Plotly.newPlot('lineChartDiv', [lineTrace], lineLayout);
      
      // 饼图：category分布
      const categoryCount = {};
      csvData.forEach(d => {
        categoryCount[d.category] = (categoryCount[d.category] || 0) + 1;
      });
      
      const pieTrace = {
        labels: Object.keys(categoryCount),
        values: Object.values(categoryCount),
        type: 'pie',
        textinfo: 'label+percent',
        textposition: 'outside',
        marker: {
          colors: ['#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6']
        }
      };
      
      const pieLayout = {
        title: '兴趣领域分布',
        margin: { t: 50, r: 50, b: 50, l: 50 }
      };
      
      Plotly.newPlot('pieChartDiv', [pieTrace], pieLayout);
      
      // 3D散点图：score1, score2, score3
      const scatter3dTrace = {
        x: csvData.map(d => d.score1),
        y: csvData.map(d => d.score2),
        z: csvData.map(d => d.score3),
        mode: 'markers',
        type: 'scatter3d',
        text: csvData.map(d => `${d.name}<br>类别: ${d.category}`),
        marker: {
          size: 8,
          color: csvData.map(d => d.score1 + d.score2 + d.score3),
          colorscale: 'Viridis',
          showscale: true,
          colorbar: { title: '总分' }
        }
      };
      
      const scatter3dLayout = {
        title: '三维能力坐标分布',
        scene: {
          xaxis: { title: 'Score1' },
          yaxis: { title: 'Score2' },
          zaxis: { title: 'Score3' }
        },
        margin: { t: 50, r: 50, b: 50, l: 50 }
      };
      
      Plotly.newPlot('scatter3dChartDiv', [scatter3dTrace], scatter3dLayout);
    }
    
    // 更新统计信息
    function updateStats() {
      if (csvData.length === 0) return;
      
      const totalRecords = csvData.length;
      const avgAge = (csvData.reduce((sum, d) => sum + d.age, 0) / totalRecords).toFixed(1);
      const maxScore = Math.max(...csvData.map(d => Math.max(d.score1, d.score2, d.score3)));
      
      document.getElementById('totalRecords').textContent = totalRecords;
      document.getElementById('avgAge').textContent = avgAge;
      document.getElementById('maxScore').textContent = maxScore;
    }
    
    // 图表切换功能
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        // 移除所有活跃状态
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.chart-panel').forEach(p => p.classList.remove('active'));
        
        // 添加当前活跃状态
        btn.classList.add('active');
        const chartType = btn.dataset.chart;
        
        if (chartType === 'line') {
          document.getElementById('lineChart').classList.add('active');
        } else if (chartType === 'pie') {
          document.getElementById('pieChart').classList.add('active');
        } else if (chartType === 'scatter3d') {
          document.getElementById('scatter3dChart').classList.add('active');
        }
      });
    });
    
    // 文件上传处理
    document.getElementById('uploadCsv').addEventListener('click', () => {
      document.getElementById('csvFileInput').click();
    });
    
    document.getElementById('csvFileInput').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          const csvText = e.target.result;
          csvData = parseCSV(csvText);
          updateCharts();
          updateStats();
        };
        reader.readAsText(file);
      }
    });
    
    // 加载示例数据按钮
    document.getElementById('loadSampleData').addEventListener('click', loadSampleData);
    
    // 页面加载时自动加载示例数据
    document.addEventListener('DOMContentLoaded', loadSampleData);
   </script>
 </body>
</html>